{% extends 'base.html' %}
{% load i18n %}
{% block head_theme_overrides %}
  {% if survey.style.theme_css_light or survey.style.theme_css_dark %}
  <style>
    {% if survey.style.theme_css_light %}
    [data-theme="census-light"] {
      {{ survey.style.theme_css_light|safe }}
    }
    {% endif %}
    {% if survey.style.theme_css_dark %}
    [data-theme="census-dark"] {
      {{ survey.style.theme_css_dark|safe }}
    }
    {% endif %}
  </style>
  {% endif %}
  {% if survey.style.font_css_url %}
    <link href="{{ survey.style.font_css_url }}" rel="stylesheet" />
  {% endif %}
{% endblock %}
{% block title %}{% trans "Dashboard" %} - {{ survey.name }}{% endblock %}
{% block content %}
<div class="prose">
  {% trans "Surveys" as bc_surveys %}
  {% trans "Survey Dashboard" as bc_survey_dashboard %}
  {% include 'components/breadcrumbs.html' with crumb1_label=bc_surveys crumb1_href="/surveys/" crumb2_label=bc_survey_dashboard crumb2_href="/surveys/"|add:survey.slug|add:"/dashboard/" %}
  <h2>{{ survey.name }}</h2>
  <p>{% trans "Status" %}: <strong>{{ survey.status }}</strong> · {% trans "Visibility" %}: <strong>{{ visible }}</strong></p>
  <p>{% trans "Window" %}: {{ survey.start_at|default:'—' }} → {{ survey.end_at|default:'—' }}</p>
  <p>{% trans "Total responses" %}: <strong>{{ total }}</strong>{% if survey.max_responses %} / {{ survey.max_responses }}{% endif %}</p>
  <div class="flex gap-2">
    <a class="btn btn-primary btn-sm" href="/surveys/{{ survey.slug }}/preview/">{% trans "Preview (read-only)" %}</a>
    <a class="btn btn-primary btn-sm" href="/surveys/{{ survey.slug }}/groups/">{% trans "Manage groups" %}</a>
  </div>
  <div class="mt-3 text-sm opacity-80 max-w-3xl">
    <p>{% blocktrans %}<strong>Groups</strong> are reusable sets of questions. You can mark one or more groups as a repeating entity (for example, <em>People</em> or <em>Visits</em>) directly on the Groups page, with optional one-level nesting.{% endblocktrans %}</p>
  </div>
</div>

<div class="mt-6">
  <details class="mb-6">
  <summary class="cursor-pointer select-none text-lg font-semibold">{% trans "Survey style" %}</summary>
    <form class="mt-3 grid md:grid-cols-2 gap-3" method="post" action="/surveys/{{ survey.slug }}/style/update">
      {% csrf_token %}
      <div>
        <label class="label">Title override</label>
        <input class="input input-bordered w-full" name="title" value="{{ survey.style.title }}" placeholder="Defaults to platform title" />
      </div>
      <div>
        <label class="label">Icon URL</label>
        <input class="input input-bordered w-full" name="icon_url" value="{{ survey.style.icon_url }}" placeholder="/static/favicon.ico or absolute URL" />
      </div>
      <div>
        <label class="label">Theme name</label>
        <input class="input input-bordered w-full" name="theme_name" value="{{ survey.style.theme_name }}" placeholder="e.g. census, light, dark" />
      </div>
      <div>
        <label class="label">Primary color (hex)</label>
        <input class="input input-bordered w-full" name="primary_color" value="{{ survey.style.primary_color }}" placeholder="#fac8cd" />
        <p class="text-xs opacity-70 mt-1">Tip: paste a hex like #ff3366 — it will be converted to the correct OKLCH internally.</p>
      </div>
      <div>
        <label class="label">Heading font (CSS stack)</label>
        <input class="input input-bordered w-full" name="font_heading" value="{{ survey.style.font_heading }}" placeholder="'IBM Plex Sans', ui-sans-serif, ..." />
      </div>
      <div>
        <label class="label">Body font (CSS stack)</label>
        <input class="input input-bordered w-full" name="font_body" value="{{ survey.style.font_body }}" placeholder="Merriweather, ui-serif, ..." />
      </div>
      <div class="md:col-span-2">
        <label class="label">Font CSS URL (e.g. Google Fonts)</label>
        <input class="input input-bordered w-full" name="font_css_url" value="{{ survey.style.font_css_url }}" placeholder="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Source+Serif+4:wght@400;700&display=swap" />
      </div>
      <div class="md:col-span-2">
        <button class="btn btn-primary" type="submit">Save style</button>
      </div>
    </form>
  </details>

  <details class="mb-6">
  <summary class="cursor-pointer select-none text-lg font-semibold">{% trans "Publish settings" %}</summary>
    <form class="mt-3 grid md:grid-cols-3 gap-3" method="post" action="/surveys/{{ survey.slug }}/dashboard/publish">
      {% csrf_token %}
      <div>
        <label class="label">{% trans "Status" %}</label>
        <select class="select select-bordered w-full" name="status">
          <option value="draft" {% if survey.status == 'draft' %}selected{% endif %}>{% trans "Draft" %}</option>
          <option value="published" {% if survey.status == 'published' %}selected{% endif %}>{% trans "Published" %}</option>
          <option value="closed" {% if survey.status == 'closed' %}selected{% endif %}>{% trans "Closed" %}</option>
        </select>
      </div>
      <div>
        <label class="label">{% trans "Visibility" %}</label>
        <select class="select select-bordered w-full" name="visibility">
          <option value="authenticated" {% if survey.visibility == 'authenticated' %}selected{% endif %}>{% trans "Authenticated" %}</option>
          <option value="public" {% if survey.visibility == 'public' %}selected{% endif %}>{% trans "Public" %}</option>
          <option value="unlisted" {% if survey.visibility == 'unlisted' %}selected{% endif %}>{% trans "Unlisted" %}</option>
          <option value="token" {% if survey.visibility == 'token' %}selected{% endif %}>{% trans "Invite token" %}</option>
        </select>
      </div>
      <div>
        <label class="label">{% trans "Max responses" %}</label>
        <input class="input input-bordered w-full" name="max_responses" type="number" min="1" value="{{ survey.max_responses }}" />
      </div>
      <div>
        <label class="label">{% trans "Start at" %}</label>
        <input class="input input-bordered w-full" name="start_at" type="datetime-local" value="{{ survey.start_at|date:'Y-m-d\\TH:i' }}" />
      </div>
      <div>
        <label class="label">{% trans "End at" %}</label>
        <input class="input input-bordered w-full" name="end_at" type="datetime-local" value="{{ survey.end_at|date:'Y-m-d\\TH:i' }}" />
      </div>
      <div class="md:col-span-3">
        <label class="cursor-pointer flex items-center gap-2">
          <input type="checkbox" class="checkbox" name="captcha_required" {% if survey.captcha_required %}checked{% endif %} />
          <span>{% trans "Require CAPTCHA for anonymous submissions" %}</span>
        </label>
      </div>
      <div class="md:col-span-3 p-3 rounded bg-warning/10 border border-warning/30">
        <label class="cursor-pointer flex items-start gap-2">
          <input type="checkbox" class="checkbox mt-1" name="no_patient_data_ack" {% if survey.no_patient_data_ack %}checked{% endif %} />
          <span class="text-sm">{% blocktrans %}I confirm no <strong>patient-identifiable data</strong> is collected in this survey. This is required when using Public, Unlisted, or Token visibility to prevent unauthorised access.{% endblocktrans %}</span>
        </label>
      </div>
      <div class="md:col-span-3">
        <button class="btn btn-primary" type="submit">{% trans "Save publish settings" %}</button>
        {% if survey.visibility == 'unlisted' and survey.unlisted_key %}
        <span class="ml-3 text-sm opacity-80">{% trans "Unlisted link" %}: <code class="font-mono">/surveys/{{ survey.slug }}/take/unlisted/{{ survey.unlisted_key }}/</code></span>
        {% endif %}
        {% if survey.visibility == 'public' %}
        <span class="ml-3 text-sm opacity-80">{% trans "Public link" %}: <code class="font-mono">/surveys/{{ survey.slug }}/take/</code></span>
        {% endif %}
      </div>
    </form>
    {% if survey.visibility == 'token' %}
      <div class="mt-3">
        <a class="btn btn-primary btn-sm" href="/surveys/{{ survey.slug }}/tokens/">{% trans "Manage invite tokens" %}</a>
      </div>
    {% endif %}
  </details>

  {# Group management is available on the Groups page #}
</div>
{% endblock %}
