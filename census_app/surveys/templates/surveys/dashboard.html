{% extends 'base.html' %}
{% load i18n %}
{% block head_theme_overrides %}
  {% if survey.style.theme_css_light or survey.style.theme_css_dark %}
  <style>
    {% if survey.style.theme_css_light %}
    [data-theme="census-light"] {
      {{ survey.style.theme_css_light|safe }}
    }
    {% endif %}
    {% if survey.style.theme_css_dark %}
    [data-theme="census-dark"] {
      {{ survey.style.theme_css_dark|safe }}
    }
    {% endif %}
  </style>
  {% endif %}
  {% if survey.style.font_css_url %}
    <link href="{{ survey.style.font_css_url }}" rel="stylesheet" />
  {% endif %}
{% endblock %}
{% block title %}{% trans "Dashboard" %} - {{ survey.name }}{% endblock %}
{% block content %}
<div role="alert" class="alert alert-info">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="h-6 w-6 shrink-0 stroke-current">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
  </svg>
  <span>{% trans "Keep track of survey status, number of responses and control styling." %}</span>
</div>
<div class="prose">
  {% trans "Surveys" as bc_surveys %}
  {% trans "Survey Dashboard" as bc_survey_dashboard %}
  {% include 'components/breadcrumbs.html' with crumb1_label=bc_surveys crumb1_href="/surveys/" crumb2_label=bc_survey_dashboard crumb2_href="/surveys/"|add:survey.slug|add:"/dashboard/" %}
  <h2>{{ survey.name }}</h2>
  <div class="flex flex-wrap gap-2 items-center mb-2">
    <span class="badge badge-primary badge-outline">{% trans "Status" %}: {{ survey.status }}</span>
    <span class="badge badge-primary badge-outline">{% trans "Visibility" %}: {{ visible }}</span>
    <span class="badge badge-primary badge-outline">{% trans "Window" %}: {{ survey.start_at|default:'—' }} → {{ survey.end_at|default:'—' }}</span>
    <span class="badge badge-primary badge-outline">{% trans "Total responses" %}: {{ total }}{% if survey.max_responses %} / {{ survey.max_responses }}{% endif %}</span>
  </div>
  <div class="flex flex-wrap gap-2">
    <a class="btn btn-primary btn-sm" href="/surveys/{{ survey.slug }}/preview/">{% trans "Preview (read-only)" %}</a>
    <a class="btn btn-primary btn-sm" href="/surveys/{{ survey.slug }}/groups/">{% trans "Manage groups" %}</a>
    {% if can_manage_users %}
    <a class="btn btn-primary btn-sm" href="/surveys/{{ survey.slug }}/users/">{% trans "Manage collaborators" %}</a>
    {% endif %}
  </div>
  <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
    <div class="stat bg-base-100 rounded-box shadow-sm">
      <div class="stat-title">{% trans "Today" %}</div>
      <div class="stat-value text-primary">{{ today_count }}</div>
      <div class="stat-desc">{% trans "Submissions" %}</div>
    </div>
    <div class="stat bg-base-100 rounded-box shadow-sm">
      <div class="stat-title">{% trans "Last 7 days" %}</div>
      <div class="stat-value text-primary">{{ last7_count }}</div>
      <div class="stat-desc">{% trans "Submissions" %}</div>
    </div>
    <div class="stat bg-base-100 rounded-box shadow-sm col-span-2">
      <div class="stat-title">{% trans "Last 14 days" %}</div>
      <div class="stat-desc">
        {% if spark_points %}
          <svg viewBox="0 0 100 24" width="100%" height="24" preserveAspectRatio="none" aria-label="Sparkline of last 14 days">
            <polyline points="{{ spark_points }}" fill="none" stroke="currentColor" stroke-width="2" class="text-primary/80" />
          </svg>
        {% else %}
          <div class="opacity-60">{% trans "No submissions yet" %}</div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="mt-3 text-sm opacity-80 max-w-3xl">
    <p>{% blocktrans %}<strong>Groups</strong> are reusable sets of questions. You can mark one or more groups as a repeating entity (for example, <em>People</em> or <em>Visits</em>) directly on the Groups page, with optional one-level nesting.{% endblocktrans %}</p>
  </div>
</div>

<div class="mt-6">
  <details class="mb-6">
  <summary class="cursor-pointer select-none text-lg font-semibold">{% trans "Survey style" %}</summary>
    <form class="mt-3 grid md:grid-cols-2 gap-3" method="post" action="/surveys/{{ survey.slug }}/style/update">
      {% csrf_token %}
      <div>
        <label class="label">Title override</label>
        <input class="input input-bordered w-full" name="title" value="{{ survey.style.title }}" placeholder="Defaults to platform title" />
      </div>
      <div>
        <label class="label">Icon URL</label>
        <input class="input input-bordered w-full" name="icon_url" value="{{ survey.style.icon_url }}" placeholder="/static/favicon.ico or absolute URL" />
      </div>
      <div>
        <label class="label">Theme name</label>
        <input class="input input-bordered w-full" name="theme_name" value="{{ survey.style.theme_name }}" placeholder="e.g. census, light, dark" />
      </div>
      <div>
        <label class="label">Primary color (hex)</label>
        <input class="input input-bordered w-full" name="primary_color" value="{{ survey.style.primary_color }}" placeholder="#fac8cd" />
        <p class="text-xs opacity-70 mt-1">Tip: paste a hex like #ff3366 — it will be converted to the correct OKLCH internally.</p>
      </div>
      <div>
        <label class="label">Heading font (CSS stack)</label>
        <input class="input input-bordered w-full" name="font_heading" value="{{ survey.style.font_heading }}" placeholder="'IBM Plex Sans', ui-sans-serif, ..." />
      </div>
      <div>
        <label class="label">Body font (CSS stack)</label>
        <input class="input input-bordered w-full" name="font_body" value="{{ survey.style.font_body }}" placeholder="Merriweather, ui-serif, ..." />
      </div>
      <div class="md:col-span-2">
        <label class="label">Font CSS URL (e.g. Google Fonts)</label>
        <input class="input input-bordered w-full" name="font_css_url" value="{{ survey.style.font_css_url }}" placeholder="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Source+Serif+4:wght@400;700&display=swap" />
      </div>
      <div class="md:col-span-2">
        <button class="btn btn-primary" type="submit">Save style</button>
      </div>
    </form>
  </details>

  <details class="mb-6">
  <summary class="cursor-pointer select-none text-lg font-semibold">{% trans "Publish settings" %}
    <a class="link link-primary text-sm ml-2 align-middle" href="{% url 'core:docs_page' slug='publish-and-collection' %}">{% trans "Learn more" %}</a>
  </summary>
    <form class="mt-3 grid md:grid-cols-3 gap-3" method="post" action="/surveys/{{ survey.slug }}/dashboard/publish">
      {% csrf_token %}
      <div>
        <label class="label flex items-center gap-2">{% trans "Status" %}
          <a class="tooltip tooltip-right" data-tip="{% trans 'Draft: build only · Published: accept submissions · Closed: stop submissions' %}" href="{% url 'core:docs_page' slug='publish-and-collection' %}">
            <span class="link link-hover text-sm">{% trans "What’s this?" %}</span>
          </a>
        </label>
        <select class="select select-bordered w-full" name="status">
          <option value="draft" {% if survey.status == 'draft' %}selected{% endif %}>{% trans "Draft" %}</option>
          <option value="published" {% if survey.status == 'published' %}selected{% endif %}>{% trans "Published" %}</option>
          <option value="closed" {% if survey.status == 'closed' %}selected{% endif %}>{% trans "Closed" %}</option>
        </select>
      </div>
      <div>
        <label class="label flex items-center gap-2">{% trans "Visibility" %}
          <a class="tooltip tooltip-right" data-tip="{% trans 'Authenticated: login required · Public: open link · Unlisted: secret link · Invite token: one-time codes' %}" href="{% url 'core:docs_page' slug='publish-and-collection' %}">
            <span class="link link-hover text-sm">{% trans "What’s this?" %}</span>
          </a>
        </label>
        <select class="select select-bordered w-full" name="visibility">
          <option value="authenticated" {% if survey.visibility == 'authenticated' %}selected{% endif %}>{% trans "Authenticated" %}</option>
          <option value="public" {% if survey.visibility == 'public' %}selected{% endif %}>{% trans "Public" %}</option>
          <option value="unlisted" {% if survey.visibility == 'unlisted' %}selected{% endif %}>{% trans "Unlisted" %}</option>
          <option value="token" {% if survey.visibility == 'token' %}selected{% endif %}>{% trans "Invite token" %}</option>
        </select>
      </div>
      <div>
        <label class="label">{% trans "Max responses" %}</label>
        <input class="input input-bordered w-full" name="max_responses" type="number" min="1" value="{{ survey.max_responses }}" />
      </div>
      <div>
        <label class="label">{% trans "Start at" %}</label>
        <input class="input input-bordered w-full" name="start_at" type="datetime-local" value="{% if survey.start_at %}{{ survey.start_at|date:'Y-m-d\\TH:i' }}{% endif %}" />
      </div>
      <div>
        <label class="label">{% trans "End at" %}</label>
        <input class="input input-bordered w-full" name="end_at" type="datetime-local" value="{% if survey.end_at %}{{ survey.end_at|date:'Y-m-d\\TH:i' }}{% endif %}" />
      </div>
      <div class="md:col-span-3">
        <label class="cursor-pointer flex items-center gap-2">
          <input type="checkbox" class="checkbox" name="captcha_required" {% if survey.captcha_required %}checked{% endif %} />
          <span>{% trans "Require CAPTCHA for anonymous submissions" %}</span>
        </label>
      </div>
      <div class="md:col-span-3 p-3 rounded bg-warning/10 border border-warning/30">
        <label class="cursor-pointer flex items-start gap-2">
          <input type="checkbox" class="checkbox mt-1" name="no_patient_data_ack" {% if survey.no_patient_data_ack %}checked{% endif %} />
          <span class="text-sm">{% blocktrans %}I confirm no <strong>patient-identifiable data</strong> is collected in this survey. This is required when using Public, Unlisted, or Token visibility to prevent unauthorised access.{% endblocktrans %}</span>
        </label>
      </div>
      <div class="md:col-span-3">
        <button class="btn btn-primary" type="submit">{% trans "Save publish settings" %}</button>
        {% if survey.visibility == 'unlisted' and survey.unlisted_key %}
        <span class="ml-3 text-sm opacity-80">{% trans "Unlisted link" %}: <code class="font-mono">/surveys/{{ survey.slug }}/take/unlisted/{{ survey.unlisted_key }}/</code></span>
        {% endif %}
        {% if survey.visibility == 'public' %}
        <span class="ml-3 text-sm opacity-80">{% trans "Public link" %}: <code class="font-mono">/surveys/{{ survey.slug }}/take/</code></span>
        {% endif %}
      </div>
    </form>
    {% if survey.visibility == 'token' %}
      <div class="mt-3">
        <a class="btn btn-primary btn-sm" href="/surveys/{{ survey.slug }}/tokens/">{% trans "Manage invite tokens" %}</a>
      </div>
    {% endif %}
  </details>

  {# Group management is available on the Groups page #}

  {# Danger zone - Delete survey #}
  <details class="collapse collapse-arrow bg-error/10 border border-error/30 mt-6">
    <summary class="cursor-pointer select-none text-lg font-semibold text-error">
      {% trans "Danger Zone" %}
    </summary>
    <div class="mt-4 p-4">
      <div class="alert alert-error mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <div>
          <h3 class="font-bold">{% trans "Delete this survey" %}</h3>
          <p class="text-sm">{% trans "Once deleted, all data, responses, groups, and permissions will be permanently removed. This action cannot be undone." %}</p>
        </div>
      </div>
      <a href="{% url 'surveys:delete' survey.slug %}" class="btn btn-error">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
        {% trans "Delete Survey" %}
      </a>
    </div>
  </details>
</div>
{% endblock %}
