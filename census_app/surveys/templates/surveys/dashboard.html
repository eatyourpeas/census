{% extends 'base.html' %}
{% load i18n %}
{% block head_theme_overrides %}
  {% if survey.style.theme_css_light or survey.style.theme_css_dark %}
  <style>
    {% if survey.style.theme_css_light %}
    [data-theme="census-light"] {
      {{ survey.style.theme_css_light|safe }}
    }
    {% endif %}
    {% if survey.style.theme_css_dark %}
    [data-theme="census-dark"] {
      {{ survey.style.theme_css_dark|safe }}
    }
    {% endif %}
  </style>
  {% endif %}
  {% if survey.style.font_css_url %}
    <link href="{{ survey.style.font_css_url }}" rel="stylesheet" />
  {% endif %}
{% endblock %}
{% block title %}{% trans "Dashboard" %} - {{ survey.name }}{% endblock %}
{% block content %}
<div role="alert" class="alert alert-info">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="h-6 w-6 shrink-0 stroke-current">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
  </svg>
  <span>{% trans "Keep track of survey status, number of responses and control styling." %}</span>
</div>
<div class="prose">
  {% trans "Surveys" as bc_surveys %}
  {% trans "Survey Dashboard" as bc_survey_dashboard %}
  {% include 'components/breadcrumbs.html' with crumb1_label=bc_surveys crumb1_href="/surveys/" crumb2_label=bc_survey_dashboard crumb2_href="/surveys/"|add:survey.slug|add:"/dashboard/" %}
  <h2>{{ survey.name }}</h2>
</div>

<div class="flex flex-wrap gap-2 items-center mb-2">
  <span class="badge badge-primary badge-outline">{% trans "Status" %}: {{ survey.status }}</span>
  <span class="badge badge-primary badge-outline">{% trans "Visibility" %}: {{ visible }}</span>
  <span class="badge badge-primary badge-outline">{% trans "Window" %}: {{ survey.start_at|default:'—' }} → {{ survey.end_at|default:'—' }}</span>
  <span class="badge badge-primary badge-outline">{% trans "Total responses" %}: {{ total }}{% if survey.max_responses %} / {{ survey.max_responses }}{% endif %}</span>
  {% if survey.visibility == 'token' %}
    <a class="badge badge-primary badge-outline hover:bg-primary hover:text-primary-content transition-colors cursor-pointer" href="{% url 'surveys:invites_pending' slug=survey.slug %}">{% trans "Invites" %}: {{ invites_sent }} / {{ total }}</a>
  {% endif %}
</div>

<div class="flex flex-wrap gap-2 mb-4">
  {% if survey.status == 'draft' %}
    <a class="btn btn-success btn-sm flex-shrink-0" href="{% url 'surveys:publish_settings' slug=survey.slug %}">
      {% include "components/icons/cloud-upload.html" with classes="w-5 h-5 mr-1" %}
      {% trans "Publish Survey" %}
    </a>
  {% elif survey.status == 'published' %}
    <a class="btn btn-primary btn-sm flex-shrink-0" href="{% url 'surveys:publish_settings' slug=survey.slug %}">
      {% include "components/icons/pencil.html" with classes="w-4 h-4 mr-1" %}
      {% trans "Edit Publication" %}
    </a>
  {% endif %}
  <a class="btn btn-primary btn-sm flex-shrink-0" href="/surveys/{{ survey.slug }}/preview/">{% trans "Survey Preview (read-only)" %}</a>
  <a class="btn btn-primary btn-sm flex-shrink-0" href="/surveys/{{ survey.slug }}/groups/">{% trans "Manage question groups" %}</a>
  {% if can_manage_users %}
  <a class="btn btn-primary btn-sm flex-shrink-0" href="/surveys/{{ survey.slug }}/users/">{% trans "Manage collaborators" %}</a>
  {% endif %}
  {% if survey.status == 'published' %}
    {% if survey.visibility == 'public' %}
      <button class="btn btn-outline btn-sm flex-shrink-0 copy-survey-link" data-slug="{{ survey.slug }}" data-url="{{ request.scheme }}://{{ request.get_host }}/surveys/{{ survey.slug }}/take/">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        {% trans "Copy Survey Link" %}
      </button>
    {% elif survey.visibility == 'unlisted' and survey.unlisted_key %}
      <button class="btn btn-outline btn-sm flex-shrink-0 copy-survey-link" data-slug="{{ survey.slug }}" data-url="{{ request.scheme }}://{{ request.get_host }}/surveys/{{ survey.slug }}/take/unlisted/{{ survey.unlisted_key }}/">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        {% trans "Copy Survey Link" %}
      </button>
    {% endif %}
  {% endif %}
</div>

<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
  <div class="stat bg-base-100 rounded-box shadow-sm">
    <div class="stat-title">{% trans "Today" %}</div>
    <div class="stat-value text-primary">{{ today_count }}</div>
    <div class="stat-desc">{% trans "Submissions" %}</div>
  </div>
  <div class="stat bg-base-100 rounded-box shadow-sm">
    <div class="stat-title">{% trans "Last 7 days" %}</div>
    <div class="stat-value text-primary">{{ last7_count }}</div>
    <div class="stat-desc">{% trans "Submissions" %}</div>
  </div>
  <div class="stat bg-base-100 rounded-box shadow-sm sm:col-span-2">
    <div class="stat-title">{% trans "Submission Trend" %}</div>
    <div class="stat-value text-primary">
      {% if survey.max_responses %}
        {{ total }}/{{ survey.max_responses }}
      {% else %}
        {{ total }}
      {% endif %}
    </div>
    <div class="stat-desc">
      {% if survey_not_started %}
        <div class="opacity-60">{% trans "Survey not yet started - no data available" %}</div>
      {% elif spark_points %}
        <svg viewBox="0 0 100 24" width="100%" height="24" preserveAspectRatio="none" aria-label="Submission trend chart">
          <polyline points="{{ spark_points }}" fill="none" stroke="currentColor" stroke-width="2" class="text-primary/80" />
          {% if invites_points %}
            <polyline points="{{ invites_points }}" fill="none" stroke="currentColor" stroke-width="1" class="text-secondary/60" stroke-dasharray="3,2" />
          {% endif %}
        </svg>
        <div class="text-xs opacity-70 mt-1 flex gap-3">
          <span><span class="inline-block w-3 h-0.5 bg-primary/80 align-middle"></span> {% trans "Responses" %}</span>
          {% if invites_points %}
            <span><span class="inline-block w-3 h-px bg-secondary/60 align-middle" style="border-top: 1px dashed currentColor;"></span> {% trans "Invites sent" %}</span>
          {% endif %}
        </div>
      {% else %}
        <div class="opacity-60">{% trans "No submissions yet" %}</div>
      {% endif %}
    </div>
  </div>
</div>

{% if survey.is_closed %}
<div class="mt-6 card bg-base-100 shadow-xl">
  <div class="card-body">
    <h2 class="card-title">
      {% trans "Data Governance" %}
      <a href="/docs/data-governance-export" class="btn btn-ghost btn-xs ml-auto" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        {% trans "Documentation" %}
      </a>
    </h2>
    
    <div class="alert alert-info mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <div class="text-sm">
        <p>{% blocktrans %}This survey is closed and data retention is active. See the {% endblocktrans %}<a href="/docs/data-governance-export" class="link" target="_blank">{% trans "data governance policy" %}</a>{% blocktrans %} for download procedures and retention guidelines.{% endblocktrans %}</p>
      </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="stat bg-base-200 rounded-box">
        <div class="stat-title">{% trans "Survey Status" %}</div>
        <div class="stat-value text-sm">{% trans "Closed" %}</div>
        <div class="stat-desc">{% trans "Closed on" %} {{ survey.closed_at|date:"Y-m-d H:i" }}</div>
      </div>
      
      <div class="stat bg-base-200 rounded-box">
        <div class="stat-title">{% trans "Retention Period" %}</div>
        <div class="stat-value text-sm">{{ survey.retention_months }} {% trans "months" %}</div>
        {% if survey.deletion_date %}
        <div class="stat-desc">{% trans "Deletion scheduled" %}: {{ survey.deletion_date|date:"Y-m-d" }}</div>
        {% endif %}
      </div>
    </div>

    {% if can_export %}
    <div class="card-actions justify-end mt-4">
      {% if total > 0 %}
      <a href="{% url 'surveys:survey_export_create' survey.slug %}" class="btn btn-primary">
        {% include "components/icons/download.html" with classes="h-4 w-4 mr-1" %}
        {% trans "Download Survey Data" %}
      </a>
      {% else %}
      <button class="btn btn-disabled"
              disabled
              title="{% trans 'No responses to export' %}">
        {% include "components/icons/download.html" with classes="h-4 w-4 mr-1" %}
        {% trans "Download Survey Data" %}
      </button>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

<div class="prose mt-3">
  <div class="text-sm opacity-80 max-w-3xl">
    <p>{% blocktrans %}<strong>Groups</strong> are reusable sets of questions. You can mark one or more groups as a repeating entity (for example, <em>People</em> or <em>Visits</em>) directly on the Groups page, with optional one-level nesting.{% endblocktrans %}</p>
  </div>
</div>

<div class="mt-6">
  <details class="mb-6">
  <summary class="cursor-pointer select-none text-lg font-semibold">{% trans "Survey style" %}</summary>
    <form class="mt-3 grid md:grid-cols-2 gap-3" method="post" action="/surveys/{{ survey.slug }}/style/update">
      {% csrf_token %}
      <div>
        <label class="label">Title override</label>
        <input class="input input-bordered w-full" name="title" value="{{ survey.style.title }}" placeholder="Defaults to platform title" />
      </div>
      <div>
        <label class="label">Icon URL</label>
        <input class="input input-bordered w-full" name="icon_url" value="{{ survey.style.icon_url }}" placeholder="/static/favicon.ico or absolute URL" />
      </div>
      <div>
        <label class="label">Theme name</label>
        <input class="input input-bordered w-full" name="theme_name" value="{{ survey.style.theme_name }}" placeholder="e.g. census, light, dark" />
      </div>
      <div>
        <label class="label">Primary color (hex)</label>
        <input class="input input-bordered w-full" name="primary_color" value="{{ survey.style.primary_color }}" placeholder="#fac8cd" />
        <p class="text-xs opacity-70 mt-1">Tip: paste a hex like #ff3366 — it will be converted to the correct OKLCH internally.</p>
      </div>
      <div>
        <label class="label">Heading font (CSS stack)</label>
        <input class="input input-bordered w-full" name="font_heading" value="{{ survey.style.font_heading }}" placeholder="'IBM Plex Sans', ui-sans-serif, ..." />
      </div>
      <div>
        <label class="label">Body font (CSS stack)</label>
        <input class="input input-bordered w-full" name="font_body" value="{{ survey.style.font_body }}" placeholder="Merriweather, ui-serif, ..." />
      </div>
      <div class="md:col-span-2">
        <label class="label">Font CSS URL (e.g. Google Fonts)</label>
        <input class="input input-bordered w-full" name="font_css_url" value="{{ survey.style.font_css_url }}" placeholder="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Source+Serif+4:wght@400;700&display=swap" />
      </div>
      <div class="md:col-span-2">
        <button class="btn btn-primary" type="submit">Save style</button>
      </div>
    </form>
  </details>

  {# Group management is available on the Groups page #}

  {# Danger zone - Delete survey #}
  <details class="collapse collapse-arrow bg-error/10 border border-error/30 mt-6">
    <summary class="cursor-pointer select-none text-lg font-semibold text-error">
      {% trans "Danger Zone" %}
    </summary>
    <div class="mt-4 p-4">
      <div class="alert alert-error mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <div>
          <h3 class="font-bold">{% trans "Delete this survey" %}</h3>
          <p class="text-sm">{% trans "Once deleted, all data, responses, groups, and permissions will be permanently removed. This action cannot be undone." %}</p>
        </div>
      </div>
      <a href="{% url 'surveys:delete' survey.slug %}" class="btn btn-error">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
        {% trans "Delete Survey" %}
      </a>
    </div>
  </details>
</div>

<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  const copyButtons = document.querySelectorAll('.copy-survey-link');

  copyButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const url = this.dataset.url;
      const originalText = this.innerHTML;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(() => {
          // Show success feedback
          this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>{% trans "Copied!" %}';
          this.classList.add('btn-success');

          setTimeout(() => {
            this.innerHTML = originalText;
            this.classList.remove('btn-success');
          }, 2000);
        }).catch(() => {
          fallbackCopy(url, this, originalText);
        });
      } else {
        fallbackCopy(url, this, originalText);
      }
    });
  });

  function fallbackCopy(text, button, originalText) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();

    try {
      document.execCommand('copy');
      button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>{% trans "Copied!" %}';
      button.classList.add('btn-success');

      setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
      }, 2000);
    } catch (err) {
      alert('{% trans "Failed to copy. Please copy manually:" %} ' + text);
    }

    document.body.removeChild(textarea);
  }
});
</script>
{% endblock %}
