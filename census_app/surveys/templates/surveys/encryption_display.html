{% extends "surveys/base.html" %}
{% load i18n %}

{% block title %}{% trans "Your Encryption Keys" %} - {{ survey.name }}{% endblock %}

{% block extra_head %}
<style>
  @media print {
    .no-print { display: none !important; }
    .card { border: 2px solid #000; }
  }
  .recovery-word {
    @apply font-mono text-sm px-3 py-2 bg-base-200 rounded border border-base-300;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
  <div class="alert alert-success mb-6 no-print">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
    <div>
      <h3 class="font-bold">{% trans "Survey Published Successfully!" %}</h3>
      <p class="text-sm">{% trans "Your survey is now published with encryption enabled." %}</p>
    </div>
  </div>

  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h1 class="card-title text-3xl mb-2 flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-warning" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        {% trans "Save Your Encryption Keys" %}
      </h1>

      <div class="alert alert-warning">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
        <div>
          <h4 class="font-bold text-lg">{% trans "Critical: This is the only time you will see these keys!" %}</h4>
          <ul class="list-disc list-inside mt-2 text-sm">
            <li>{% trans "Write down or print your recovery phrase immediately" %}</li>
            <li>{% trans "Store it in a safe place (not on your computer)" %}</li>
            <li>{% trans "You'll need your password OR recovery phrase to access survey data" %}</li>
            <li>{% trans "If you lose both, your data cannot be recovered" %}</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Recovery Phrase Section -->
  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title text-2xl mb-4 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
        </svg>
        {% trans "Recovery Phrase" %}
        <span class="badge badge-primary">{% trans "Backup Method" %}</span>
      </h2>

      <p class="mb-4 text-sm opacity-80">
        {% trans "If you forget your password, use this 12-word recovery phrase to unlock your survey:" %}
      </p>

      <div class="grid grid-cols-3 md:grid-cols-4 gap-3 mb-4">
        {% for word in recovery_words %}
        <div class="recovery-word">
          <span class="text-xs opacity-60">{{ forloop.counter }}.</span>
          <strong>{{ word }}</strong>
        </div>
        {% endfor %}
      </div>

      <div class="alert alert-info">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <div class="text-sm">
          <strong>{% trans "Recovery hint:" %}</strong> {{ recovery_hint }}
          <p class="mt-1 opacity-80">{% trans "Use this hint to verify you have the correct recovery phrase." %}</p>
        </div>
      </div>

      <div class="card-actions justify-end mt-4 no-print">
        <button class="btn btn-sm btn-outline" onclick="copyRecoveryPhrase()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
          {% trans "Copy to Clipboard" %}
        </button>
      </div>
    </div>
  </div>

  <!-- Encryption Key Section (for technical users) -->
  <div class="collapse collapse-arrow bg-base-200 mb-6">
    <input type="checkbox" />
    <div class="collapse-title text-lg font-medium">
      {% trans "Advanced: Encryption Key (Hexadecimal)" %}
    </div>
    <div class="collapse-content">
      <p class="text-sm opacity-80 mb-3">
        {% trans "This is the raw 256-bit encryption key in hexadecimal format. Most users should use the recovery phrase above instead." %}
      </p>
      <div class="mockup-code text-xs">
        <pre><code>{{ kek_hex }}</code></pre>
      </div>
      <button class="btn btn-sm btn-outline mt-3" onclick="copyKey()">
        {% trans "Copy Key" %}
      </button>
    </div>
  </div>

  <!-- Actions -->
  <div class="card bg-base-100 shadow-xl no-print">
    <div class="card-body">
      <h3 class="font-bold text-lg mb-3">{% trans "Next Steps" %}</h3>

      <div class="flex flex-wrap gap-3 mb-4">
        <button class="btn btn-outline btn-sm" onclick="window.print()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
          </svg>
          {% trans "Print This Page" %}
        </button>

        <button class="btn btn-outline btn-sm" onclick="downloadAsText()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
          {% trans "Download as Text File" %}
        </button>
      </div>

      <form method="post">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary btn-block">
          {% trans "I have saved my recovery information" %}
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </button>
      </form>

      <p class="text-xs text-center mt-3 opacity-60">
        {% trans "After clicking this button, you will not be able to view these keys again." %}
      </p>
    </div>
  </div>
</div>

<script>
function copyRecoveryPhrase() {
  const phrase = "{{ recovery_phrase }}";
  navigator.clipboard.writeText(phrase).then(() => {
    alert("{% trans 'Recovery phrase copied to clipboard!' %}");
  });
}

function copyKey() {
  const key = "{{ kek_hex }}";
  navigator.clipboard.writeText(key).then(() => {
    alert("{% trans 'Encryption key copied to clipboard!' %}");
  });
}

function downloadAsText() {
  const content = `Survey: {{ survey.name }}
Survey Slug: {{ survey.slug }}
Generated: {{ survey.published_at|date:"Y-m-d H:i:s" }}

=== RECOVERY PHRASE (12 words) ===
{{ recovery_phrase }}

Recovery Hint: {{ recovery_hint }}

=== ENCRYPTION KEY (Hexadecimal) ===
{{ kek_hex }}

=== IMPORTANT ===
- Keep this information safe and secure
- You need your password OR recovery phrase to unlock your survey
- If you lose both, your data cannot be recovered
- Store this in a secure location (password manager, safe, etc.)
`;

  const blob = new Blob([content], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'survey-{{ survey.slug }}-encryption-keys.txt';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>
{% endblock %}
