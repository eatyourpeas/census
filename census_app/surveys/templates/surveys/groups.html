{% extends 'base.html' %}
{% block head_theme_overrides %}
  {% if survey.style.theme_css_light or survey.style.theme_css_dark %}
  <style>
    {% if survey.style.theme_css_light %}
    [data-theme="census-light"] {
      {{ survey.style.theme_css_light|safe }}
    }
    {% endif %}
    {% if survey.style.theme_css_dark %}
    [data-theme="census-dark"] {
      {{ survey.style.theme_css_dark|safe }}
    }
    {% endif %}
  </style>
  {% endif %}
  {% if survey.style.font_css_url %}
    <link href="{{ survey.style.font_css_url }}" rel="stylesheet" />
  {% endif %}
{% endblock %}
{% block title %}Groups - {{ survey.name }}{% endblock %}
{% block content %}
<div class="prose">
  {% include 'components/breadcrumbs.html' with crumb1_label="Survey Dashboard" crumb1_href="/surveys/"|add:survey.slug|add:"/dashboard/" crumb2_label="Groups" %}
  <h1 class="inline-flex items-center gap-2">
    {% include "components/icons/documents.html" with classes="w-6 h-6" %}
    <span>Groups for {{ survey.name }}</span>
  </h1>
</div>

<div class="mt-4">

  <div class="space-y-3">
    <ul id="groups-draggable" class="orderable-list w-full flex flex-col gap-3" aria-label="Reorder groups" data-reorder-url="/surveys/{{ survey.slug }}/groups/reorder" data-can-edit="{{ can_edit|yesno:'true,false' }}">
      {% for g in groups %}
        <li class="w-full" data-gid="{{ g.id }}">
          <div class="w-full bg-base-100 rounded-lg border border-base-300 p-3">
            <div class="flex items-center gap-3">
              {% if can_edit %}
              <button type="button" class="drag-handle inline-flex items-center justify-center w-7 h-7 mr-1 rounded-md text-primary border border-primary/30 hover:bg-primary/20 shrink-0 cursor-move" style="background-color: color-mix(in oklch, var(--p) 12%, transparent);" aria-label="Drag to reorder" title="Drag to reorder">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48" fill="currentColor" aria-hidden="true" focusable="false"><path d="M14 20h20v-4H14v4Zm0 6h20v-4H14v4Zm0 6h20v-4H14v4Z"/></svg>
              </button>
              {% endif %}
              <div class="q-number badge badge-primary badge-sm shrink-0">{{ forloop.counter }}</div>
              <div class="flex-1 min-w-0">
                <a class="font-medium link text-primary" href="/surveys/{{ survey.slug }}/builder/groups/{{ g.id }}/">{{ g.name }}</a>
                {% if g.description %}<div class="text-sm opacity-70">{{ g.description }}</div>{% endif %}
              </div>
              <div class="badge badge-neutral shrink-0 self-center">{{ g.q_count|default:0 }} question{% if g.q_count|default:0 != 1 %}s{% endif %}</div>
              {% if can_edit %}
              <form method="post" action="/surveys/{{ survey.slug }}/groups/{{ g.id }}/delete" onsubmit="return confirm('Delete this group?');" class="shrink-0">
                {% csrf_token %}
                <button class="btn btn-sm btn-warning" type="submit">Delete</button>
              </form>
              {% endif %}
            </div>
          </div>
        </li>
      {% empty %}
        <li class="opacity-70">No groups yet. Create one to get started.</li>
      {% endfor %}
    </ul>
    <div class="flex gap-2">
  {% if can_edit %}
  <button id="save-order-btn" class="btn btn-primary btn-sm" type="button" disabled>Save order</button>
      {% endif %}
      <a class="btn btn-ghost btn-sm " href="/surveys/{{ survey.slug }}/dashboard/">Back to dashboard</a>
    </div>
  </div>
</div>

<div class="flex flex-wrap items-center gap-3 mb-4 relative z-[9999]">
    {% if can_edit %}
    <form method="post" action="/surveys/{{ survey.slug }}/groups/create" class="inline-flex">
      {% csrf_token %}
      <div class="join">
      <input id="create-group-name" class="input input-bordered join-item" name="name" placeholder="New group name" required />
      <button id="create-group-submit" class="btn join-item btn-primary" type="submit" disabled>Create new question group</button>
      </div>
      
    </form>
    <div class="dropdown dropdown-top dropdown-center">
        <div tabindex="0" role="button" class="btn m-1 btn-primary">Create from template</div>
        <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-1 w-52 p-2 shadow-sm">
            <li>
                <form method="post" action="/surveys/{{ survey.slug }}/groups/template/create">
                    {% csrf_token %}
                    <input type="hidden" name="template" value="patient_details_encrypted" />
                    <button type="submit">Patient details (encrypted)</button>
                </form>
            </li>
            <li>
            <form method="post" action="/surveys/{{ survey.slug }}/groups/template/create">
                {% csrf_token %}
                <input type="hidden" name="template" value="professional_details" />
                <button type="submit">Professional details</button>
            </form>
            </li>
        </ul>
    </div>
    {% endif %}
  </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script src="{% load static %}{% static 'js/groups.js' %}"></script>
{% endblock %}
