{% extends 'base.html' %}
{% load i18n static survey_extras %}
{% block head_theme_overrides %}
  {% if survey.style.theme_css_light or survey.style.theme_css_dark %}
  <style>
    {% if survey.style.theme_css_light %}
    [data-theme="census-light"] {
      {{ survey.style.theme_css_light|safe }}
    }
    {% endif %}
    {% if survey.style.theme_css_dark %}
    [data-theme="census-dark"] {
      {{ survey.style.theme_css_dark|safe }}
    }
    {% endif %}
  </style>
  {% endif %}
  {% if survey.style.font_css_url %}
    <link href="{{ survey.style.font_css_url }}" rel="stylesheet" />
  {% endif %}
{% endblock %}
{% block title %}{% trans "Groups" %} - {{ survey.name }}{% endblock %}
{% block content %}
<div class="prose">
  {% include 'components/breadcrumbs.html' with crumb1_label="Survey Dashboard" crumb1_href="/surveys/"|add:survey.slug|add:"/dashboard/" crumb2_label="Groups" %}
  <h1 class="inline-flex items-center gap-2">
    {% include "components/icons/documents.html" with classes="w-6 h-6 " %}
  <span class="text-primary">{% blocktrans %}Groups for {{ survey }}{% endblocktrans %}</span>
  </h1>
  <p class="mt-2 text-sm opacity-80">{% blocktrans %}Groups are reusable sets of questions. Arrange them here to control the order in which participants see question sets. You can also mark a set of groups as a repeating entity (e.g. People or Visits) directly here—no separate collections screen required.{% endblocktrans %}</p>
</div>

<div class="mt-4">

  <div class="space-y-3">
    <ul id="groups-draggable" class="orderable-list w-full flex flex-col gap-3" aria-label="Reorder groups" data-reorder-url="/surveys/{{ survey.slug }}/groups/reorder" data-can-edit="{{ can_edit|yesno:'true,false' }}">
      {% for g in groups %}
        {% with info=repeat_info|get_item:g.id %}
        <li class="w-full" data-gid="{{ g.id }}" data-repeat="{{ info.is_repeated|default_if_none:False|yesno:'1,0' }}" title="{{ info.tooltip }}">
          <div class="w-full bg-base-100 rounded-lg border border-base-300 p-3 selectable-group hover:border-primary cursor-pointer {% if info.is_repeated %}ring-1 ring-primary/40 bg-primary/5{% endif %}">
            <div class="flex items-center gap-3">
              {% if can_edit %}
              <button type="button" class="drag-handle inline-flex items-center justify-center w-7 h-7 mr-1 rounded-md text-primary border border-primary/30 hover:bg-primary/20 shrink-0 cursor-move" style="background-color: color-mix(in oklch, var(--p) 12%, transparent);" aria-label="Drag to reorder" title="Drag to reorder">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48" fill="currentColor" aria-hidden="true" focusable="false"><path d="M14 20h20v-4H14v4Zm0 6h20v-4H14v4Zm0 6h20v-4H14v4Z"/></svg>
              </button>
              {% endif %}
              {% if can_edit %}
              <input type="checkbox" class="checkbox checkbox-sm select-checkbox" aria-label="Select group" />
              {% endif %}
              <div class="q-number badge badge-primary badge-sm shrink-0">{{ forloop.counter }}</div>
              <div class="flex-1 min-w-0">
                <a class="font-medium link text-primary" href="/surveys/{{ survey.slug }}/builder/groups/{{ g.id }}/">{{ g.name }}</a>
                {% if g.description %}<div class="text-sm opacity-70">{{ g.description }}</div>{% endif %}
              </div>
              {% if info.is_repeated %}
                <div class="tooltip" data-tip="{{ info.tooltip }}">
                  <div class="badge badge-info shrink-0 self-center inline-flex items-center gap-1">
                    {% include "components/icons/repeat.html" with classes="w-4 h-4" %}
                    <span>Repeats</span>
                  </div>
                </div>
              {% else %}
                <div class="badge badge-neutral shrink-0 self-center">{{ g.q_count|default:0 }} question{% if g.q_count|default:0 != 1 %}s{% endif %}</div>
              {% endif %}
              {% if can_edit %}
              <form method="post" action="/surveys/{{ survey.slug }}/groups/{{ g.id }}/delete" onsubmit="return confirm('Delete this group?');" class="shrink-0">
                {% csrf_token %}
                <button class="btn btn-sm btn-warning" type="submit">Delete</button>
              </form>
              {% endif %}
            </div>
          </div>
        </li>
        {% endwith %}
      {% empty %}
        <li class="opacity-70">No groups yet. Create one to get started.</li>
      {% endfor %}
    </ul>
    <div class="flex flex-wrap gap-2 items-center">
  {% if can_edit %}
  <button id="save-order-btn" class="btn btn-primary btn-sm" type="button" disabled>{% trans "Save order" %}</button>
  <button id="create-repeat-btn" class="btn btn-secondary btn-sm inline-flex items-center gap-2" type="button" disabled>
    {% include "components/icons/repeat.html" with classes="w-4 h-4" %}
    <span>{% trans "Create repeat from selection" %}</span>
  </button>
      {% endif %}
      <a class="btn btn-ghost btn-sm " href="/surveys/{{ survey.slug }}/dashboard/">{% trans "Back to dashboard" %}</a>
    </div>
  </div>
</div>

<div class="flex flex-wrap items-center gap-3 mb-4 relative z-[9999]">
    {% if can_edit %}
    <form method="post" action="/surveys/{{ survey.slug }}/groups/create" class="inline-flex">
      {% csrf_token %}
      <div class="join">
  <input id="create-group-name" class="input input-bordered join-item" name="name" placeholder="{% trans "New group name" %}" required />
  <button id="create-group-submit" class="btn join-item btn-primary" type="submit" disabled>{% trans "Create new question group" %}</button>
      </div>
      
    </form>
    <div class="dropdown dropdown-top dropdown-center">
  <div tabindex="0" role="button" class="btn m-1 btn-primary">{% trans "Create from template" %}</div>
        <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-1 w-52 p-2 shadow-sm">
            <li>
                <form method="post" action="/surveys/{{ survey.slug }}/groups/template/create">
                    {% csrf_token %}
                    <input type="hidden" name="template" value="patient_details_encrypted" />
                    <button type="submit">{% trans "Patient details (encrypted)" %}</button>
                </form>
            </li>
            <li>
            <form method="post" action="/surveys/{{ survey.slug }}/groups/template/create">
                {% csrf_token %}
                <input type="hidden" name="template" value="professional_details" />
                <button type="submit">{% trans "Professional details" %}</button>
            </form>
            </li>
        </ul>
    </div>
    {% endif %}
  </div>

    {% if can_edit %}
    <dialog id="repeat-modal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg">{% trans "Create repeat" %}</h3>
        <form method="post" action="/surveys/{{ survey.slug }}/groups/repeat/create" id="repeat-form">
          {% csrf_token %}
          <input type="hidden" name="group_ids" id="repeat-group-ids" />
          <div class="mt-2">
            <label class="label">{% trans "Repeat name" %}</label>
            <input class="input input-bordered w-full" name="name" required />
          </div>
          <div class="mt-2 grid grid-cols-2 gap-3">
            <div>
              <label class="label">{% trans "Minimum items" %}</label>
              <input class="input input-bordered w-full" name="min_count" type="number" min="0" value="0" />
            </div>
            <div>
              <label class="label">{% trans "Maximum items" %}</label>
              <select class="select select-bordered w-full" name="max_count">
                <option value="">{% trans "Unlimited" %}</option>
                {% int_range 1 10 as nums %}
                {% for n in nums %}
                <option value="{{ n }}">{{ n }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          {% if existing_repeats %}
          <div class="mt-2">
            <label class="label">{% trans "Nest under existing (optional)" %}</label>
            <select class="select select-bordered w-full" name="parent_id">
              <option value="">—</option>
              {% for c in existing_repeats %}
              <option value="{{ c.id }}">{{ c.name }}</option>
              {% endfor %}
            </select>
            <p class="text-xs opacity-70 mt-1">{% trans "Nesting is limited to one level." %}</p>
          </div>
          {% endif %}
          <div class="modal-action">
            <button class="btn" type="button" onclick="document.getElementById('repeat-modal').close()">{% trans "Cancel" %}</button>
            <button class="btn btn-primary" type="submit">{% trans "Create" %}</button>
          </div>
        </form>
      </div>
    </dialog>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script src="{% static 'js/groups.js' %}"></script>
  <script>
    (function(){
      var root = document.getElementById('groups-draggable');
      if (!root) return;
      var saveBtn = document.getElementById('save-order-btn');
      var createBtn = document.getElementById('create-repeat-btn');
      var modal = document.getElementById('repeat-modal');
      var inputIds = document.getElementById('repeat-group-ids');
      var selected = new Set();
      function refresh() {
        if (createBtn) createBtn.disabled = selected.size === 0;
      }
      // Clicks on list items toggle selection (except when directly clicking the checkbox)
      root.addEventListener('click', function(e){
        var li = e.target.closest('li[data-gid]');
        if (!li) return;
        // don't toggle on drag/delete or when clicking the checkbox itself
        if (e.target.closest('.drag-handle') || e.target.closest('form') || e.target.closest('.select-checkbox')) return;
        var cb = li.querySelector('.select-checkbox');
        if (!cb) return;
        cb.checked = !cb.checked;
        if (cb.checked) {
          selected.add(li.dataset.gid);
          li.classList.add('ring-2','ring-secondary');
        } else {
          selected.delete(li.dataset.gid);
          li.classList.remove('ring-2','ring-secondary');
        }
        refresh();
      });
      // Changes on the checkbox (mouse/keyboard) update selection
      root.addEventListener('change', function(e){
        if (!e.target.classList.contains('select-checkbox')) return;
        var li = e.target.closest('li[data-gid]');
        if (!li) return;
        if (e.target.checked) {
          selected.add(li.dataset.gid);
          li.classList.add('ring-2','ring-secondary');
        } else {
          selected.delete(li.dataset.gid);
          li.classList.remove('ring-2','ring-secondary');
        }
        refresh();
      });
      if (createBtn) createBtn.addEventListener('click', function(){
        if (!selected.size) return;
        if (inputIds) inputIds.value = Array.from(selected).join(',');
        if (modal && modal.showModal) modal.showModal();
      });
    })();
  </script>
{% endblock %}
