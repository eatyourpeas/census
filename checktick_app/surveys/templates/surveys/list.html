{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block title %}{% trans "Your Surveys" %} - CheckTick{% endblock %}
{% block content %}
<div class="prose max-w-none">
  {% include 'components/breadcrumbs.html' with crumb1_label='Surveys' crumb1_href='/surveys/' %}
  <h1 class="inline-flex items-center gap-2">
    {% include "components/icons/clipboard.html" with classes="w-6 h-6 text-base-content" %}
    <span>{% trans "Your Surveys" %}</span>
  </h1>
  {% if user.is_authenticated %}
    <p><a class="btn btn-primary not-prose" href="/surveys/create/">{% trans "Create survey" %}</a></p>
  {% endif %}
  {% if surveys %}
  <ul class="not-prose w-full flex flex-col gap-3">
      {% for s in surveys %}
        <li class="w-full">
          <div class="w-full bg-base-100 rounded-lg border border-base-300 p-3 sm:p-4 hover:border-primary transition-colors">
            <div class="flex items-center gap-4 min-w-0">
              <div class="flex-shrink-0 inline-flex items-center justify-center">
                {% include "components/icons/census_brand.html" with classes=brand.icon_size_class|default:'w-8 h-8' aria_label=brand.icon_alt|default:brand.title title=brand.icon_title|default:brand.title %}
              </div>
              <div class="min-w-0 w-full">
                <div class="flex items-center gap-2 min-w-0">
                  <div class="font-medium leading-tight truncate">{{ s.name }}</div>
                  <span class="badge badge-primary badge-outline whitespace-nowrap">{{ s.get_status_display|default:s.status }}</span>
                  {% if s.status == 'published' %}
                    {% with days=s.days_remaining %}
                      {% if days is None %}
                        <span class="badge badge-info badge-outline whitespace-nowrap">{% trans "No end date" %}</span>
                      {% elif days < 0 %}
                        <span class="badge badge-error badge-outline whitespace-nowrap">{% trans "Expired" %}</span>
                      {% elif days == 0 %}
                        <span class="badge badge-warning badge-outline whitespace-nowrap">{% trans "Ends today" %}</span>
                      {% elif days == 1 %}
                        <span class="badge badge-warning badge-outline whitespace-nowrap">{% trans "1 day remaining" %}</span>
                      {% elif days <= 7 %}
                        <span class="badge badge-warning badge-outline whitespace-nowrap">{{ days }} {% trans "days remaining" %}</span>
                      {% else %}
                        <span class="badge badge-success badge-outline whitespace-nowrap">{{ days }} {% trans "days remaining" %}</span>
                      {% endif %}
                    {% endwith %}
                  {% endif %}
                </div>
                {% if s.description %}
                  <div class="text-sm opacity-70 truncate">{{ s.description }}</div>
                {% endif %}
              </div>
            </div>
            <div class="-mx-1 overflow-x-auto mt-3">
              <div class="px-1 min-w-max flex items-center gap-2">
                {% if s.status == 'draft' %}
                  <a class="btn btn-success btn-sm" href="{% url 'surveys:publish_settings' slug=s.slug %}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    {% trans "Publish" %}
                  </a>
                {% elif s.status == 'published' %}
                  <a class="btn btn-primary btn-sm" href="{% url 'surveys:publish_settings' slug=s.slug %}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    {% trans "Edit Publication" %}
                  </a>
                {% endif %}
                <a class="btn btn-primary btn-sm" href="/surveys/{{ s.slug }}/dashboard/">{% trans "Dashboard" %}</a>
                <a class="btn btn-primary btn-sm" href="/surveys/{{ s.slug }}/groups/">{% trans "Groups" %}</a>
                <a class="btn btn-primary btn-sm" href="/surveys/{{ s.slug }}/preview/">{% trans "Preview" %}</a>
                <a class="btn btn-primary btn-sm" href="/surveys/{{ s.slug }}/bulk-upload/">{% trans "Import" %}</a>
                {% if s.status == 'published' %}
                  {% if s.visibility == 'public' %}
                    <button class="btn btn-outline btn-sm copy-survey-link" data-slug="{{ s.slug }}" data-url="{{ request.scheme }}://{{ request.get_host }}/surveys/{{ s.slug }}/take/">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                      {% trans "Copy Link" %}
                    </button>
                  {% elif s.visibility == 'unlisted' and s.unlisted_key %}
                    <button class="btn btn-outline btn-sm copy-survey-link" data-slug="{{ s.slug }}" data-url="{{ request.scheme }}://{{ request.get_host }}/surveys/{{ s.slug }}/take/unlisted/{{ s.unlisted_key }}/">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                      {% trans "Copy Link" %}
                    </button>
                  {% endif %}
                {% endif %}
              </div>
            </div>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>{% trans "No surveys yet." %}</p>
  {% endif %}
</div>

<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  const copyButtons = document.querySelectorAll('.copy-survey-link');

  copyButtons.forEach(button => {
    button.addEventListener('click', function() {
      const url = this.dataset.url;
      const originalText = this.innerHTML;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(() => {
          // Show success feedback
          this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>{% trans "Copied!" %}';
          this.classList.add('btn-success');

          setTimeout(() => {
            this.innerHTML = originalText;
            this.classList.remove('btn-success');
          }, 2000);
        }).catch(() => {
          fallbackCopy(url, this, originalText);
        });
      } else {
        fallbackCopy(url, this, originalText);
      }
    });
  });

  function fallbackCopy(text, button, originalText) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();

    try {
      document.execCommand('copy');
      button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>{% trans "Copied!" %}';
      button.classList.add('btn-success');

      setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
      }, 2000);
    } catch (err) {
      alert('{% trans "Failed to copy. Please copy manually:" %} ' + text);
    }

    document.body.removeChild(textarea);
  }
});
</script>
{% endblock %}
