# Internationalization (i18n)

Census includes comprehensive internationalization support, allowing you to translate the application into multiple languages and support users worldwide.

## Overview

The i18n implementation provides:

- **Language Detection**: Automatic language detection from browser settings
- **User Preferences**: Per-user language selection stored in the database
- **Translation System**: Django's translation framework with gettext
- **Pluralization Support**: Proper handling of singular/plural forms
- **Multiple Languages**: Support for English (en) and English UK (en-gb) by default

## How It Works

### Language Detection Priority

Census uses a cascading approach to determine which language to display:

1. **User Preference** (highest priority): If the user is authenticated and has saved a language preference, use that
2. **Session Language**: Language stored in the current session
3. **Browser Language**: Language from the browser's `Accept-Language` header
4. **Default Setting**: Falls back to `LANGUAGE_CODE = "en-gb"` from settings

### Architecture

The i18n system consists of three main components:

#### 1. LocaleMiddleware (Django Built-in)
Located in the middleware stack, this detects language from the session and browser headers.

#### 2. UserLanguageMiddleware (Custom)
Custom middleware that overrides the detected language with the user's saved preference. This runs after authentication middleware to access `request.user`.

#### 3. UserLanguagePreference Model
Database model that stores each user's language choice:

```python
class UserLanguagePreference(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    language = models.CharField(max_length=10, choices=settings.LANGUAGES)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
```

## Available Languages

Currently supported languages:

| Code | Language | Status |
|------|----------|--------|
| `en` | English (US) | ‚úÖ Active |
| `en-gb` | English (UK) | ‚úÖ Active |

## For Developers

### Marking Strings for Translation

#### In Python Code (Views, Models, Forms)

```python
from django.utils.translation import gettext as _

# Simple translation
message = _("Email preferences updated successfully.")

# With variable substitution
message = _("Welcome, %(username)s!") % {"username": user.username}
```

#### In Templates

```django
{% load i18n %}

{# Simple translation #}
<h1>{% trans "Profile" %}</h1>

{# With variable substitution #}
<p>{% blocktrans %}Signed in as <strong>{{ username }}</strong>{% endblocktrans %}</p>

{# Pluralization #}
<div class="tooltip" data-tip="{% blocktrans count orgs=stats.orgs_owned %}You own {{ orgs }} organization{% plural %}You own {{ orgs }} organizations{% endblocktrans %}">
```

**Important**: Do not use other Django template tags (like `{% if %}`) inside `{% blocktrans %}` blocks. Extract the translation outside the conditional:

```django
{# ‚ùå Wrong - will cause syntax error #}
{% if count > 0 %}
  {% blocktrans %}You have {{ count }} item{% plural %}You have {{ count }} items{% endblocktrans %}
{% endif %}

{# ‚úÖ Correct - translation in data attribute #}
{% if count > 0 %}
  <div data-tip="{% blocktrans count items=count %}You have {{ items }} item{% plural %}You have {{ items }} items{% endblocktrans %}">
{% endif %}
```

### Generating Translation Files

After marking strings for translation, generate the message files:

```bash
# Generate for all languages
docker compose exec web python manage.py makemessages -l en -l en_GB

# Or generate for specific language
docker compose exec web python manage.py makemessages -l en
```

This creates/updates files in `locale/{language}/LC_MESSAGES/django.po`

### Editing Translations

Edit the `.po` files to provide translations:

```po
# locale/en/LC_MESSAGES/django.po
#: census_app/core/templates/core/profile.html:3
msgid "Profile"
msgstr "Profile"  # Edit this line for translations

# Pluralization
msgid "You own %(orgs)s organization"
msgid_plural "You own %(orgs)s organizations"
msgstr[0] "You own %(orgs)s organization"    # Singular
msgstr[1] "You own %(orgs)s organizations"   # Plural
```

### Compiling Translations

After editing `.po` files, compile them to binary format:

```bash
docker compose exec web python manage.py compilemessages
```

This creates `.mo` files that Django uses at runtime.

### Testing Translations

1. **Change browser language**: Set your browser's preferred language to test automatic detection
2. **Test user preferences**: Create a language switcher UI to test per-user preferences
3. **Check pluralization**: Test with different counts to ensure singular/plural forms work

## Current Implementation Status

### ‚úÖ Completed

- **Infrastructure**
  - LocaleMiddleware configured
  - UserLanguagePreference model with migration
  - Custom UserLanguageMiddleware implemented
  - Locale directories created (`locale/en/`, `locale/en_GB/`)
  - Translation files generated and compiled

- **Translated Components** (~5% of application)
  - Profile page badge tooltips (11 tooltips with pluralization)
  - Profile page headings and static text
  - Core view success/error messages

### üîÑ In Progress

- Template translation (~700+ strings remaining)
- View/form translation
- Model verbose names and help text
- Email templates

### ‚è≥ Planned

- Language switcher UI component
- Additional language support
- Admin interface translations
- Documentation translations

## Adding a New Language

To add support for a new language:

### 1. Update Settings

Add the language to `LANGUAGES` in `census_app/settings.py`:

```python
LANGUAGES = [
    ("en", "English"),
    ("en-gb", "English (UK)"),
    ("fr", "Fran√ßais"),  # New language
    ("es", "Espa√±ol"),   # New language
]
```

### 2. Generate Translation Files

```bash
docker compose exec web python manage.py makemessages -l fr
docker compose exec web python manage.py makemessages -l es
```

### 3. Translate Strings

Edit the generated `.po` files:
- `locale/fr/LC_MESSAGES/django.po`
- `locale/es/LC_MESSAGES/django.po`

### 4. Compile Translations

```bash
docker compose exec web python manage.py compilemessages
```

### 5. Restart Container

```bash
docker compose restart web
```

## File Locations

### Configuration
- `census_app/settings.py` - Lines 68-78 (middleware), 123-135 (i18n settings)
- `census_app/core/middleware.py` - UserLanguageMiddleware implementation
- `census_app/core/models.py` - Lines 112-147 (UserLanguagePreference model)

### Migrations
- `census_app/core/migrations/0005_userlanguagepreference.py`

### Translation Files
- `locale/en/LC_MESSAGES/django.po` - English message catalog
- `locale/en/LC_MESSAGES/django.mo` - Compiled English translations
- `locale/en_GB/LC_MESSAGES/django.po` - English (UK) message catalog
- `locale/en_GB/LC_MESSAGES/django.mo` - Compiled English (UK) translations

### Documentation
- `docs/i18n.md` - This file
- `docs/i18n-progress.md` - Detailed implementation progress tracker

## Best Practices

### 1. Mark All User-Facing Strings
Every string that users see should be marked for translation, including:
- Page titles and headings
- Button labels and links
- Form labels and help text
- Success/error messages
- Email subject lines and content
- Tooltip text

### 2. Provide Context
Use comments in templates to help translators:

```django
{# Translators: This appears on the user's profile page #}
{% trans "Your badges" %}
```

### 3. Keep Strings Complete
Don't split sentences into multiple translation strings:

```python
# ‚ùå Bad
message = _("You have") + " " + str(count) + " " + _("items")

# ‚úÖ Good
message = _("You have %(count)s items") % {"count": count}
```

### 4. Test Pluralization
Always test with counts of 0, 1, and 2+ to verify plural forms work correctly.

### 5. Update After String Changes
Whenever you modify translatable strings, regenerate the message files:

```bash
docker compose exec web python manage.py makemessages -a
docker compose exec web python manage.py compilemessages
docker compose restart web
```

## Common Issues

### Translations Not Appearing

1. **Check `.mo` files exist**: Run `compilemessages` after editing `.po` files
2. **Restart container**: Changes require restart: `docker compose restart web`
3. **Clear browser cache**: Sometimes cached responses show old translations
4. **Check middleware order**: LocaleMiddleware must be after SessionMiddleware

### Syntax Errors in Templates

```
SyntaxError: Translation blocks must not include other block tags
```

This happens when you use Django template tags inside `{% blocktrans %}`. Move the translation to a data attribute or extract it outside conditional blocks.

### Pluralization Not Working

Ensure you're using `{% blocktrans count %}` not just `{% blocktrans %}`:

```django
{# ‚ùå Wrong - no pluralization #}
{% blocktrans %}You have {{ count }} items{% endblocktrans %}

{# ‚úÖ Correct - with pluralization #}
{% blocktrans count items=count %}You have {{ items }} item{% plural %}You have {{ items }} items{% endblocktrans %}
```

## Further Reading

- [Django Internationalization Documentation](https://docs.djangoproject.com/en/stable/topics/i18n/)
- [Django Translation Documentation](https://docs.djangoproject.com/en/stable/topics/i18n/translation/)
- [GNU gettext Manual](https://www.gnu.org/software/gettext/manual/)

## Support

For questions or issues with internationalization:

1. Check the [i18n progress tracker](i18n-progress.md) for current status
2. Review this documentation
3. Open an issue on GitHub with the `i18n` label
