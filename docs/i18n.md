# Internationalization (i18n)

> **Status:** ✅ Technical implementation complete | 🟡 Translation work in progress
>
> The i18n infrastructure is fully implemented with 13 languages supported. All 329 user-facing strings are marked for translation. The language switcher is working. Professional translation work is needed for 11 non-English languages.

Census includes comprehensive internationalization support, allowing you to translate the application into multiple languages and support users worldwide.

## Overview

The i18n implementation provides:

- **Language Detection**: Automatic language detection from browser settings
- **User Preferences**: Per-user language selection stored in the database
- **Translation System**: Django's translation framework with gettext
- **Pluralization Support**: Proper handling of singular/plural forms
- **13 Languages Supported**: English (UK default), Welsh, French, Spanish, German, Italian, Portuguese, Polish, Arabic, Simplified Chinese, Hindi, and Urdu

## How It Works

### Language Detection Priority

Census uses a cascading approach to determine which language to display:

1. **User Preference** (highest priority): If the user is authenticated and has saved a language preference, use that
2. **Session Language**: Language stored in the current session
3. **Browser Language**: Language from the browser's `Accept-Language` header
4. **Default Setting**: Falls back to `LANGUAGE_CODE = "en-gb"` from settings

### Architecture

The i18n system consists of three main components:

#### 1. LocaleMiddleware (Django Built-in)

Located in the middleware stack, this detects language from the session and browser headers.

#### 2. UserLanguageMiddleware (Custom)

Custom middleware that overrides the detected language with the user's saved preference. This runs after authentication middleware to access `request.user`.

#### 3. UserLanguagePreference Model

Database model that stores each user's language choice:

```python
class UserLanguagePreference(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    language = models.CharField(max_length=10, choices=settings.LANGUAGES)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
```

## Available Languages

Currently supported languages:

| Code | Language | Status |
|------|----------|--------|
| `en` | English | ✅ Active (Source) |
| `en-gb` | English (UK) | ✅ Active (Default) |
| `cy` | Cymraeg (Welsh) | 🟡 Ready for translation |
| `fr` | Français (French) | � Demo translations (10 strings) |
| `es` | Español (Spanish) | 🟡 Ready for translation |
| `de` | Deutsch (German) | 🟡 Ready for translation |
| `it` | Italiano (Italian) | 🟡 Ready for translation |
| `pt` | Português (Portuguese) | 🟡 Ready for translation |
| `pl` | Polski (Polish) | 🟡 Ready for translation |
| `ar` | العربية (Arabic) | 🟡 Ready for translation |
| `zh-hans` | 简体中文 (Simplified Chinese) | 🟡 Ready for translation |
| `hi` | हिन्दी (Hindi) | 🟡 Ready for translation |
| `ur` | اردو (Urdu) | 🟡 Ready for translation |

**Total**: 13 languages, 329 translatable strings (276 unique base strings + pluralization variants)

## For Developers

### Marking Strings for Translation

#### In Python Code (Views, Models, Forms)

```python
from django.utils.translation import gettext as _

# Simple translation
message = _("Email preferences updated successfully.")

# With variable substitution
message = _("Welcome, %(username)s!") % {"username": user.username}
```

#### In Templates

```django
{% load i18n %}

{# Simple translation #}
<h1>{% trans "Profile" %}</h1>

{# With variable substitution #}
<p>{% blocktrans %}Signed in as <strong>{{ username }}</strong>{% endblocktrans %}</p>

{# Pluralization #}
<div class="tooltip" data-tip="{% blocktrans count orgs=stats.orgs_owned %}You own {{ orgs }} organization{% plural %}You own {{ orgs }} organizations{% endblocktrans %}">
```

**Important**: Do not use other Django template tags (like `{% if %}`) inside `{% blocktrans %}` blocks. Extract the translation outside the conditional:

```django
{# ❌ Wrong - will cause syntax error #}
{% if count > 0 %}
  {% blocktrans %}You have {{ count }} item{% plural %}You have {{ count }} items{% endblocktrans %}
{% endif %}

{# ✅ Correct - translation in data attribute #}
{% if count > 0 %}
  <div data-tip="{% blocktrans count items=count %}You have {{ items }} item{% plural %}You have {{ items }} items{% endblocktrans %}">
{% endif %}
```

### Generating Translation Files

After marking strings for translation, generate the message files:

```bash
# Generate for all languages
docker compose exec web python manage.py makemessages -l en -l en_GB

# Or generate for specific language
docker compose exec web python manage.py makemessages -l en
```

This creates/updates files in `locale/{language}/LC_MESSAGES/django.po`

### Editing Translations

Edit the `.po` files to provide translations:

```po
# locale/en/LC_MESSAGES/django.po
#: census_app/core/templates/core/profile.html:3
msgid "Profile"
msgstr "Profile"  # Edit this line for translations

# Pluralization
msgid "You own %(orgs)s organization"
msgid_plural "You own %(orgs)s organizations"
msgstr[0] "You own %(orgs)s organization"    # Singular
msgstr[1] "You own %(orgs)s organizations"   # Plural
```

### Compiling Translations

After editing `.po` files, compile them to binary format:

```bash
docker compose exec web python manage.py compilemessages
```

This creates `.mo` files that Django uses at runtime.

### Importing Translations from Markdown Files

Census includes a management command to import translations from structured markdown files into `.po` files. This is useful when translations are provided in a more accessible format (like spreadsheets exported to markdown).

#### Translation File Format

Translation markdown files are stored in `docs/languages/` with one file per language:

- `docs/languages/COMPLETE_STRINGS_LIST.md` - Master list of English strings (numbered 1-101)
- `docs/languages/arabic.md` - Arabic translations
- `docs/languages/chinese.md` - Simplified Chinese translations
- `docs/languages/french.md` - French translations
- `docs/languages/german.md` - German translations
- *(and so on for all supported languages)*

**Master List Format** (`COMPLETE_STRINGS_LIST.md`):
```markdown
1. Sign up
2. Login to start
3. Email preferences updated successfully.
...
```

**Translation File Format** (table with three columns):
```markdown
| # | English | Translation |
|---|---------|-------------|
| 1. | Sign up | اشتراك |
| 2. | Login to start | تسجيل الدخول للبدء |
| 3. | Email preferences updated successfully. | تم تحديث تفضيلات البريد الإلكتروني بنجاح. |
```

#### Running the Import

To import all translations:

```bash
# Dry run (preview changes without modifying files)
docker compose exec web python manage.py import_translations --dry-run

# Actual import
docker compose exec web python manage.py import_translations
```

The command will:

1. Parse the master English string list (`COMPLETE_STRINGS_LIST.md`)
2. Read the English `.po` template file to match strings
3. For each language, read the markdown translation file
4. Match translations by number (1-101)
5. Restore HTML tags and `\n` formatting from the English `.po` entries
6. Update each language's `.po` file with the formatted translations
7. Preserve all `.po` file headers and metadata

#### How It Works

The import process uses a number-based matching system:

1. **Master List**: Each string is numbered (e.g., "1. Your Profile")
2. **English Template**: Matches numbered strings to `.po` msgid entries
3. **Translation Files**: Provides translations for each numbered string
4. **Format Restoration**: HTML tags and newlines are copied from English msgid to translated msgstr

**Example:**

English `.po` entry:
```po
msgid "View all <strong>surveys</strong>"
msgstr ""
```

Master list entry:
```markdown
42. View all surveys
```

Translation file entry:
```markdown
| 42. | View all surveys | Voir tous les enquêtes |
```

Result in French `.po`:
```po
msgid "View all <strong>surveys</strong>"
msgstr "Voir tous les <strong>enquêtes</strong>"
```

The HTML `<strong>` tags are automatically restored from the English msgid!

#### Output

After running, you'll see:

```
Found 101 numbered strings in master list
Found 317 English msgid entries
Matched 92 strings between .po and master list

Processing: ar (arabic.md)
✓ Updated 92 translations in django.po

Processing: fr (french.md)
✓ Updated 92 translations in django.po

...

✓ Total: 987 translations updated across all languages
Now run: docker compose exec web python manage.py compilemessages
```

#### After Import

Don't forget to compile the translations:

```bash
docker compose exec web python manage.py compilemessages
docker compose restart web
```

#### Adding New Translation Strings

To add new strings to the markdown files:

1. Add the English string to `COMPLETE_STRINGS_LIST.md` with the next number
2. Add the same numbered entry to each language markdown file
3. Provide the translation in the "Translation" column
4. Run the import command
5. Compile and restart

#### Viewing Translation Files

All language markdown files are automatically available in the documentation system under the **Internationalization** category. You can view them at:

- **Documentation** → **Internationalization** → **[Language Name] Translations**

This allows translators to review the strings directly in the application without needing file system access.

### Testing Translations

1. **Change browser language**: Set your browser's preferred language to test automatic detection
2. **Test user preferences**: Create a language switcher UI to test per-user preferences
3. **Check pluralization**: Test with different counts to ensure singular/plural forms work

## Current Implementation Status

### ✅ Completed

- **Infrastructure**
  - LocaleMiddleware configured (position 6 in middleware stack)
  - UserLanguagePreference model with migration (0005)
  - Custom UserLanguageMiddleware implemented (position 10, after AuthenticationMiddleware)
  - Locale directories created for 13 languages
  - Translation files generated and compiled (329 strings across 13 languages)
  - Session-based language persistence implemented

- **Language Switcher UI**
  - User profile page language selector dropdown
  - Save language preference functionality
  - Immediate language activation on save
  - Session persistence across page loads and browser sessions

- **Internationalized Components** (100% markup complete)
  - **Authentication**: Login, signup, password reset, password change (8 templates)
  - **Core**: Home page, profile page (2 templates)
  - **Surveys**: All survey templates including builder, dashboard, detail, user management (13 templates)
  - **Form Components**: Field rendering, error display, checkbox/radio groups (4 templates)
  - **Base Template**: Navigation, footer, common UI elements

### 🔄 In Progress

- **Translation Work**: Actual translations for 329 strings across 11 non-English languages
  - French: ~10 demo strings translated (Home, Profile, Login, Surveys)
  - Other languages: 0% (infrastructure ready, awaiting translation)

### ⏳ Planned

- Professional translation services or collaborative translation platform
- Admin interface for managing UserLanguagePreference records
- Language selector in navigation bar for quick switching
- Documentation translations

## Adding a New Language

To add support for a new language:

### 1. Update Settings

Add the language to `LANGUAGES` in `census_app/settings.py`:

```python
LANGUAGES = [
    ("en", "English"),
    ("en-gb", "English (UK)"),
    ("fr", "Français"),  # New language
    ("es", "Español"),   # New language
]
```

### 2. Generate Translation Files

```bash
docker compose exec web python manage.py makemessages -l fr
docker compose exec web python manage.py makemessages -l es
```

### 3. Translate Strings

Edit the generated `.po` files:

- `locale/fr/LC_MESSAGES/django.po`
- `locale/es/LC_MESSAGES/django.po`

### 4. Compile Translations

```bash
docker compose exec web python manage.py compilemessages
```

### 5. Restart Container

```bash
docker compose restart web
```

## File Locations

### Configuration

- `census_app/settings.py` - Lines 68-78 (middleware), 123-135 (i18n settings)
- `census_app/core/middleware.py` - UserLanguageMiddleware implementation
- `census_app/core/models.py` - Lines 112-147 (UserLanguagePreference model)

### Migrations

- `census_app/core/migrations/0005_userlanguagepreference.py`

### Translation Files

- `locale/en/LC_MESSAGES/django.po` - English message catalog
- `locale/en/LC_MESSAGES/django.mo` - Compiled English translations
- `locale/en_GB/LC_MESSAGES/django.po` - English (UK) message catalog
- `locale/en_GB/LC_MESSAGES/django.mo` - Compiled English (UK) translations

### Documentation

- `docs/i18n.md` - This file
- `locale/README.md` - Translation file documentation and workflow

## Best Practices

### 1. Mark All User-Facing Strings

Every string that users see should be marked for translation, including:

- Page titles and headings
- Button labels and links
- Form labels and help text
- Success/error messages
- Email subject lines and content
- Tooltip text

### 2. Provide Context

Use comments in templates to help translators:

```django
{# Translators: This appears on the user's profile page #}
{% trans "Your badges" %}
```

### 3. Keep Strings Complete

Don't split sentences into multiple translation strings:

```python
# ❌ Bad
message = _("You have") + " " + str(count) + " " + _("items")

# ✅ Good
message = _("You have %(count)s items") % {"count": count}
```

### 4. Test Pluralization

Always test with counts of 0, 1, and 2+ to verify plural forms work correctly.

### 5. Update After String Changes

Whenever you modify translatable strings, regenerate the message files:

```bash
docker compose exec web python manage.py makemessages -a
docker compose exec web python manage.py compilemessages
docker compose restart web
```

## Common Issues

### Translations Not Appearing

1. **Check `.mo` files exist**: Run `compilemessages` after editing `.po` files
2. **Restart container**: Changes require restart: `docker compose restart web`
3. **Clear browser cache**: Sometimes cached responses show old translations
4. **Check middleware order**: LocaleMiddleware must be after SessionMiddleware

### Syntax Errors in Templates

```text
SyntaxError: Translation blocks must not include other block tags
```

This happens when you use Django template tags inside `{% blocktrans %}`. Move the translation to a data attribute or extract it outside conditional blocks.

### Pluralization Not Working

Ensure you're using `{% blocktrans count %}` not just `{% blocktrans %}`:

```django
{# ❌ Wrong - no pluralization #}
{% blocktrans %}You have {{ count }} items{% endblocktrans %}

{# ✅ Correct - with pluralization #}
{% blocktrans count items=count %}You have {{ items }} item{% plural %}You have {{ items }} items{% endblocktrans %}
```

## Further Reading

- [Django Internationalization Documentation](https://docs.djangoproject.com/en/stable/topics/i18n/)
- [Django Translation Documentation](https://docs.djangoproject.com/en/stable/topics/i18n/translation/)
- [GNU gettext Manual](https://www.gnu.org/software/gettext/manual/)

## Implementation Status

The Census application has complete internationalization infrastructure supporting 13 languages:

✅ **Technical Implementation Complete**

- All 329 user-facing strings marked for translation
- Language switcher UI working with session persistence
- 13 language files generated and ready for translation

🟡 **Translation Work In Progress**

**French (fr):** 45% complete (149/330 strings translated)

- ✅ Home page, profile, theme settings, language switcher
- ✅ Survey builder UI, bulk import documentation
- ✅ Dashboard elements, publish settings
- ⏳ Survey management (groups, questions, responses)
- ⏳ Authentication pages (login, signup, password reset)
- ⏳ Form components and error messages
- ⏳ User management and navigation

**Other Languages:** Translation not started

- Welsh (cy), Spanish (es), German (de), Italian (it), Portuguese (pt)
- Polish (pl), Arabic (ar), Simplified Chinese (zh-hans)
- Hindi (hi), Urdu (ur)

See `locale/README.md` for translation workflow

### French Translation - Remaining Strings (147 strings)

The following strings still need French translation. Organized by template/component:

#### Authentication & Account Management

- `Account Type`, `Admin login`, `Already have an account?`
- `Change password`, `Change your password`, `Check your email`
- `Choose a new password`, `Create account`, `Create your account`
- `Current Password`, `Don't have an account?`, `Email address`
- `Enter your email`, `Forgot your password?`, `Individual`
- `Log in`, `New Password`, `New password`
- `Organisation`, `Password`, `Password changed successfully`
- `Password reset`, `Password reset complete`, `Passwords do not match.`
- `Professional details`, `Request password reset`, `Reset my password`
- `Reset your password`, `Set new password`, `Sign up`

#### Survey Management

- `-- Select --`, `Actions`, `Add or update user`, `Add user to org`
- `Add user to survey`, `Admin`, `Back to dashboard`, `Back to survey`
- `Clear`, `Create`, `Create new question group`, `Create repeat`
- `Create repeat from selection`, `Creator`, `Delete`, `Delete Survey Permanently`
- `Delete this group?`, `Email (preferred)`, `Help`, `Import`
- `Invite Tokens`, `Manage Questions`, `Maximum items`, `Minimum items`
- `Nest under existing (optional)`, `Nesting is limited to one level.`
- `New group name`, `No`, `No groups yet. Create one to get started.`
- `No questions in this group yet.`, `No surveys yet.`, `No users.`
- `Organisation users`, `Or specify User ID if email not found:`
- `Preview`, `Question Group`, `Question Groups`, `Questions in this group`
- `Remove`, `Remove repeat`, `Remove this group from its repeat?`
- `Repeat name`, `Repeats`, `Role`, `Save`, `Selected for repeat`
- `Submit`, `Survey users`, `Thank you`, `Unlimited`, `User`
- `User ID`, `Viewer`, `Yes`, `You must type the survey name to confirm deletion.`
- `Your Surveys`, `Your response has been recorded.`, `selected`

#### Form Labels & UI Elements

- `(optional)`, `Add`, `Branch`, `Built by`, `Commit`, `Contributing`
- `Created`, `Draft`, `Issued`, `License`, `New`, `Not revoked`
- `Published`, `Redeemed`, `Redeem code`, `Repository`, `Revoke`, `Revoked`
- `Save changes`, `Status`, `Token`, `Token Status`, `Tokens`, `Type code here`
- `Used`, `Uses`, `Version`, `What's this?`

#### Long-form Text & Messages

- `Create an organisation to collaborate with a team`
- `Create surveys and manage your own responses`
- `If a reset link was sent, it will arrive shortly.`
- `If you didn't request this, you can safely ignore this email.`
- `No email? Check spam or re-enter your email above.`
- `Once deleted, all data, responses, groups, and permissions will be permanently removed. This action cannot be undone.`
- `Or use a single-use invite token if you have one:`
- `Password reset complete. You can now log in with your new password.`
- `Provide either an email or a user ID to grant access.`
- `Question Groups for %(survey)s`
- `Set a password for your account to finish signing up.`
- `To confirm deletion, please type the survey name exactly as shown above:`
- `Token redeemed! Create your account below using any email address.`
- `Tokens are revoked after first use unless marked reusable.`
- `Use this single-use code to create an account without invitation.`
- `We've sent a password reset link to your email.`
- `You must type the survey name to confirm deletion.`

For the complete list with template locations, see: `untranslated_french_strings.txt`

## Support

For questions or issues with internationalization:

1. Review this documentation and `locale/README.md`
2. Check the Django i18n documentation
3. Open an issue on GitHub with the `i18n` label
