#!/bin/bash

# Development environment startup script for Census
# This script starts the local Docker Compose development environment
# Usage: ./s/dev [--code] [--help]
#   --code    Also opens VS Code after starting containers
#   --help    Show this help message

set -e

OPEN_VSCODE=false

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --code)
            OPEN_VSCODE=true
            shift
            ;;
        --help)
            echo "Census Development Environment Startup"
            echo ""
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --code    Also opens VS Code after starting containers"
            echo "  --help    Show this help message"
            echo ""
            echo "Environment Variables:"
            echo "  OPEN_VSCODE=true    Alternative to --code flag"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Check environment variable as alternative to flag
if [[ "${OPEN_VSCODE}" == "true" ]]; then
    OPEN_VSCODE=true
fi

echo "ğŸš€ Starting Census development environment..."
echo "ğŸ“¦ Using Dockerfile.dev for development setup"

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "âŒ Docker is not running. Please start Docker and try again."
    exit 1
fi

# Build and start the development environment
echo "ğŸ—ï¸  Building and starting containers..."
docker-compose up --build -d

if [[ "$OPEN_VSCODE" == "true" ]]; then
    echo "ğŸ’» Opening VS Code..."
    if command -v code &> /dev/null; then
        code .
    else
        echo "âš ï¸  VS Code command 'code' not found in PATH"
        echo "   Make sure VS Code is installed and the 'code' command is available"
    fi
fi

echo ""
echo "âœ… Development environment is starting up!"
echo "ğŸ“ The containers will automatically:"
echo "   - Set up PostgreSQL database"
echo "   - Install npm dependencies"
echo "   - Build CSS assets"
echo "   - Run database migrations"
echo "   - Start Django development server on http://localhost:8000"
echo ""
if [[ "$OPEN_VSCODE" != "true" ]]; then
    echo "ğŸ’¡ Tip: Use '--code' flag to automatically open VS Code next time"
fi
